// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================
// 1. ROLES Y USUARIOS
// ============================================================

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50)
  users User[]
}

model User {
  id            Int       @id @default(autoincrement())
  roleId        Int       @map("role_id")
  email         String    @unique @db.VarChar(100)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  firstName     String    @map("first_name") @db.VarChar(100)
  lastName      String    @map("last_name") @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  documentId    String?   @map("document_id") @db.VarChar(50)
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  workload      Int?
  status        UserStatus?

  role                     Role                   @relation(fields: [roleId], references: [id])
  ticketsCreated           Ticket[]               @relation("UserTickets")
  ticketsAssigned          Ticket[]               @relation("AssignedTechnician")
  specialties              TechnicianSpecialty[]
  ticketHistory            TicketHistory[]
  notificationsReceived    Notification[]         @relation("RecipientNotifications")
  notificationsSent        Notification[]         @relation("SenderNotifications")
  valuations               Valuation[]
  assignments              Assignment[]

  @@map("users")
}

enum UserStatus {
  Disponible      @map("Disponible")
  No_Disponible   @map("No Disponible")

  @@map("user_status")
}

// ============================================================
// 2. ESPECIALIDADES Y TÉCNICOS
// ============================================================

model Specialty {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text

  technicians         TechnicianSpecialty[]
  categories          CategorySpecialty[]
  autoTriageRules     AutoTriageRule[]

  @@map("specialties")
}

model TechnicianSpecialty {
  userId       Int @map("user_id")
  specialtyId  Int @map("specialty_id")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@id([userId, specialtyId])
  @@map("technician_specialty")
}

// ============================================================
// 3. SLA
// ============================================================

model Sla {
  id                     Int    @id @default(autoincrement())
  name                   String @unique @db.VarChar(100)
  responseTimeMinutes    Int    @map("response_time_minutes")
  resolutionTimeMinutes  Int    @map("resolution_time_minutes")

  categories Category[]

  @@map("sla")
}

// ============================================================
// 4. CATEGORÍAS Y ETIQUETAS
// ============================================================

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String? @db.Text
  slaId       Int?    @map("sla_id")

  sla         Sla?              @relation(fields: [slaId], references: [id])
  tags        CategoryTag[]
  specialties CategorySpecialty[]
  tickets     Ticket[]

  @@map("categories")
}

model Tag {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String? @db.Text

  categories CategoryTag[]

  @@map("tags")
}

model CategoryTag {
  categoryId Int @map("category_id")
  tagId      Int @map("tag_id")

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([categoryId, tagId])
  @@map("category_tag")
}

model CategorySpecialty {
  categoryId   Int @map("category_id")
  specialtyId  Int @map("specialty_id")

  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@id([categoryId, specialtyId])
  @@map("category_specialty")
}

// ============================================================
// 5. TICKETS
// ============================================================

model Ticket {
  id                    Int            @id @default(autoincrement())
  title                 String         @db.VarChar(200)
  description           String?        @db.Text
  createdAt             DateTime       @default(now()) @map("created_at")
  firstResponseAt       DateTime?      @map("first_response_at")
  closedAt              DateTime?      @map("closed_at")
  status                TicketStatus   @default(Pendiente)
  priority              TicketPriority @default(Media)
  userId                Int            @map("user_id")
  categoryId            Int            @map("category_id")
  assignedTechnicianId  Int?           @map("assigned_technician_id")
  responseDeadline      DateTime?      @map("response_deadline")
  resolutionDeadline    DateTime?      @map("resolution_deadline")
  responseCompliance    Boolean?       @map("response_compliance")
  resolutionCompliance  Boolean?       @map("resolution_compliance")

  user               User             @relation("UserTickets", fields: [userId], references: [id])
  category           Category         @relation(fields: [categoryId], references: [id])
  assignedTechnician User?            @relation("AssignedTechnician", fields: [assignedTechnicianId], references: [id])
  images             TicketImage[]
  history            TicketHistory[]
  assignments        Assignment[]
  notifications      Notification[]
  valuations         Valuation[]

  @@map("tickets")
}

enum TicketStatus {
  Pendiente   @map("Pendiente")
  Asignado    @map("Asignado")
  En_Proceso  @map("En Proceso")
  Resuelto    @map("Resuelto")
  Cerrado     @map("Cerrado")

  @@map("ticket_status")
}

enum TicketPriority {
  Baja  @map("Baja")
  Media @map("Media")
  Alta  @map("Alta")

  @@map("ticket_priority")
}

model TicketImage {
  id         Int      @id @default(autoincrement())
  ticketId   Int      @map("ticket_id")
  imagePath  String   @map("image_path") @db.MediumText
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_images")
}

// ============================================================
// 6. HISTORIAL DE ESTADOS
// ============================================================

model TicketHistory {
  id             Int           @id @default(autoincrement())
  ticketId       Int           @map("ticket_id")
  previousStatus TicketStatus? @map("previous_status")
  newStatus      TicketStatus  @map("new_status")
  changedAt      DateTime      @default(now()) @map("changed_at")
  userId         Int           @map("user_id")
  comment        String?       @db.Text
  justification  String?       @db.Text

  ticket Ticket                @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User                  @relation(fields: [userId], references: [id])
  images HistoryStateImage[]

  @@map("ticket_history")
}

model HistoryStateImage {
  id             Int      @id @default(autoincrement())
  historyStateId Int      @map("history_state_id")
  imagePath      String   @map("image_path") @db.MediumText
  uploadedAt     DateTime @default(now()) @map("uploaded_at")

  historyState TicketHistory @relation(fields: [historyStateId], references: [id], onDelete: Cascade)

  @@map("history_state_images")
}

// ============================================================
// 7. REGLAS DE AUTO-TRIAGE
// ============================================================

model AutoTriageRule {
  id                    Int                 @id @default(autoincrement())
  name                  String              @db.VarChar(100)
  description           String?             @db.Text
  active                Boolean             @default(true)
  remainingTimeMinutes  Int                 @default(0) @map("remaining_time_minutes")
  workloadLimit         Int                 @default(0) @map("workload_limit")
  specialtyId           Int?                @map("specialty_id")
  priorityRule          AutoTriagePriority? @default(Media) @map("priority_rule")

  specialty   Specialty?    @relation(fields: [specialtyId], references: [id])
  assignments Assignment[]

  @@map("auto_triage_rules")
}

enum AutoTriagePriority {
  Baja    @map("Baja")
  Media   @map("Media")
  Alta    @map("Alta")
  Urgente @map("Urgente")

  @@map("auto_triage_priority")
}

// ============================================================
// 8. ASIGNACIONES DE TICKETS
// ============================================================

model Assignment {
  id                Int              @id @default(autoincrement())
  ticketId          Int              @map("ticket_id")
  technicianId      Int              @map("technician_id")
  method            AssignmentMethod
  assignedAt        DateTime         @default(now()) @map("assigned_at")
  autoTriageRuleId  Int?             @map("auto_triage_rule_id")
  priorityScore     Int              @default(0) @map("priority_score")
  observation       String?          @db.Text

  ticket         Ticket          @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  technician     User            @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  autoTriageRule AutoTriageRule? @relation(fields: [autoTriageRuleId], references: [id])

  @@map("assignments")
}

enum AssignmentMethod {
  Automatico @map("Automatico")
  Manual     @map("Manual")

  @@map("assignment_method")
}

// ============================================================
// 9. NOTIFICACIONES
// ============================================================

model Notification {
  id                Int              @id @default(autoincrement())
  recipientUserId   Int              @map("recipient_user_id")
  senderUserId      Int?             @map("sender_user_id")
  ticketId          Int?             @map("ticket_id")
  type              NotificationType
  message           String           @db.Text
  createdAt         DateTime         @default(now()) @map("created_at")
  isRead            Boolean          @default(false) @map("is_read")
  readAt            DateTime?        @map("read_at")
  systemGenerated   Boolean          @default(false) @map("system_generated")

  recipient User    @relation("RecipientNotifications", fields: [recipientUserId], references: [id], onDelete: Cascade)
  sender    User?   @relation("SenderNotifications", fields: [senderUserId], references: [id], onDelete: SetNull)
  ticket    Ticket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationType {
  Asignacion        @map("Asignacion")
  CambioEstado      @map("CambioEstado")
  NuevaObservacion  @map("NuevaObservacion")
  InicioSesion      @map("InicioSesion")
  Otro              @map("Otro")

  @@map("notification_type")
}

// ============================================================
// 10. VALORACIONES
// ============================================================

model Valuation {
  id        Int      @id @default(autoincrement())
  ticketId  Int      @map("ticket_id")
  userId    Int      @map("user_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ticketId, userId])
  @@map("valuations")
}
